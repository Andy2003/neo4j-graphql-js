[[horizontal-scaling]]
= Horizontal Scaling

WARNING: Subscriptions are only available as a beta its API may change in the future. It is not recommended to use subscriptions in production environments.

## The Problem
Horizontal scaling of any real time system can be tricky. Especially when dealing with long lived connections such as WebSockets.
Consider the following example, in which _Client A_ is subscribed to a certain event, that is triggered by _Client B_:

image::subscriptions/diagram1.png[title="Simple subscriptions setup"]


In the previous example, the server running the GraphQL service, will do the following:

1. Receive the _mutation_ by _Client B_.
2. Run the Cypher Query to Neo4j.
3. Trigger the subscription event to _Client A_.

This setup works fine for a single instance of `@neo4j/graphql`. However, when trying to scale horizontally, by adding more GraphQL servers,
we may encounter the following situation:

image::subscriptions/diagram2.png[title="Subscriptions with 2 servers"]

In this case, _Client B_ is subscribe to one server, however, when _Client A_ triggers the mutation, it queries a different server.

The change happens successfully in the database, and any client connected to the same server will receive the event, however, _Client A_
will **not** receive any update, as the server its connected to does not trigger any subscriptions.

This is the behaviour of the xref::subscriptions/plugins/debug.adoc[debug] plugin provided by the library, and it is not intended for production usage.

## Using PubSub
One solution to this problem, and how `@neo4j/graphql` is to use a PubSub pattern with an external broker to broadcast events through multiple
instances. This can be achieved through xref::subscriptions/plugins/index.adoc[plugins].

Following the previous example, using an intermediate broker the infrastructure would look like:

image::subscriptions/diagram3.png[title="Subscriptions with 2 servers and message broker"]

In this example, _Client B_ will query the first server, which will perform the mutation in the database, as well as sending an event to the
broker. This broker will then notify every server (including the server that originally triggered the event), ensuring that any client will
be notified, regardless on which server is connected to.

NOTE: You can find examples of usage with supported brokers in xref::subscriptions/plugins/index.adoc[plugins].
